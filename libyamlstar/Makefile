M := ../.cache/makes
$(shell [ -d $M ] || git clone -q https://github.com/makeplus/makes $M)
include $M/init.mk
include $M/graalvm.mk
include $M/lein.mk
include $M/clean.mk
include $M/shell.mk

ROOT := $(shell cd .. && pwd -P)
include $(ROOT)/common/native.mk

MAKES-CLEAN := \
  target \
  .lein-* \

MAKES-REALCLEAN := \
  lib \

# Library paths and names
YAMLSTAR_VERSION := 0.1.0-SNAPSHOT
API_VERSION := 0

LIB-DIR := lib
LIB-NAME := $(LIB-DIR)/libyamlstar
LIB-SO := $(LIB-NAME).$(SO)
LIB-SO-VERSIONED := $(LIB-NAME).$(SO).$(YAMLSTAR_VERSION)
LIB-JAR := target/libyamlstar-$(YAMLSTAR_VERSION)-standalone.jar

# Core dependency jar in local maven repository
CORE-JAR := $(MAVEN-REPOSITORY)/yamlstar/core/$(YAMLSTAR_VERSION)/core-$(YAMLSTAR_VERSION).jar

# Header files generated by native-image --shared
LIB-HEADERS := \
  $(LIB-DIR)/graal_isolate.h \
  $(LIB-NAME).h \


build: $(LIB-SO)

test:

jar: $(LIB-JAR)

install: $(LIB-SO)
	mkdir -p $(PREFIX)/include/
	install -m 644 $(LIB-HEADERS) $(PREFIX)/include/
	mkdir -p $(PREFIX)/lib/
	install -m 644 $(LIB-SO-VERSIONED) $(PREFIX)/lib/
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(PREFIX)/lib/$(notdir $(LIB-SO))
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(PREFIX)/lib/$(notdir $(LIB-SO)).$(API_VERSION)

clean::
	$(RM) -r lib/
	$(RM) src/libyamlstar/*.class

# Build and install core jar if it doesn't exist
$(CORE-JAR):
	$(MAKE) -C ../core install

$(LIB-JAR): $(CORE-JAR) $(LEIN)
	lein uberjar

$(LIB-SO): $(LIB-JAR) $(REFLECTION-JSON) $(GRAALVM)
	@echo "Building shared library..."
	mkdir -p $(LIB-DIR)
	$(GRAALVM) \
	  $(NATIVE-OPTS) \
	  --shared \
	  -jar $< \
	  -o $(LIB-NAME)
	mv $(LIB-SO) $(LIB-SO-VERSIONED)
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(LIB-SO)
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(LIB-SO).$(API_VERSION)
	@echo "Shared library created at: $(LIB-SO)"
	@echo "Headers: $(LIB-HEADERS)"
