include ../common/init.mk
include $M/graalvm.mk
include $M/lein.mk
include ../common/common.mk
include ../common/native.mk

MAKES-CLEAN := \
  target \
  .lein-* \
  src/libyamlstar/*.class \

MAKES-REALCLEAN := \
  lib \

# Library paths and names
API-VERSION := 0

# JAR files still use -SNAPSHOT (from project.clj)
# but .so files use clean version
LIB-DIR := lib
LIB-NAME := $(LIB-DIR)/libyamlstar
LIB-SO := $(LIB-NAME).$(SO)
LIB-SO-VERSIONED := $(LIB-NAME).$(SO).$(LIBYAMLSTAR-VERSION)
LIB-JAR := target/libyamlstar-$(LIBYAMLSTAR-VERSION)-SNAPSHOT-standalone.jar

# Core dependency jar in local maven repository
CORE-JAR := $(MAVEN-REPOSITORY)/yamlstar/core/$(LIBYAMLSTAR-VERSION)-SNAPSHOT/core-$(LIBYAMLSTAR-VERSION)-SNAPSHOT.jar

# Header files generated by native-image --shared
LIB-HEADERS := \
  $(LIB-DIR)/graal_isolate.h \
  $(LIB-NAME).h \


build: $(LIB-SO)

test:

jar: $(LIB-JAR)

install: $(LIB-SO)
	mkdir -p $(PREFIX)/include/
	install -m 644 $(LIB-HEADERS) $(PREFIX)/include/
	mkdir -p $(PREFIX)/lib/
	install -m 644 $(LIB-SO-VERSIONED) $(PREFIX)/lib/
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(PREFIX)/lib/$(notdir $(LIB-SO))
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(PREFIX)/lib/$(notdir $(LIB-SO)).$(API-VERSION)

$(CORE-JAR):
	$(MAKE) -C ../core install

$(LIB-JAR): $(CORE-JAR) $(LEIN)
	lein uberjar

$(LIB-SO): $(LIB-JAR) $(REFLECTION-JSON) $(GRAALVM)
	@echo "Building shared library..."
	mkdir -p $(LIB-DIR)
	$(GRAALVM) \
	  $(NATIVE-OPTS) \
	  --shared \
	  -jar $< \
	  -o $(LIB-NAME)
	mv $(LIB-SO) $(LIB-SO-VERSIONED)
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(LIB-SO)
	ln -sf $(notdir $(LIB-SO-VERSIONED)) $(LIB-SO).$(API-VERSION)
	@echo "Shared library created at: $(LIB-SO)"
	@echo "Headers: $(LIB-HEADERS)"

# Declare that these files are created as side effects of building $(LIB-SO)
$(LIB-SO-VERSIONED): $(LIB-SO)
$(LIB-NAME).h: $(LIB-SO)
$(LIB-DIR)/graal_isolate.h: $(LIB-SO)
